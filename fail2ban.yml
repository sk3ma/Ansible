---

############################################################################
# An Ansible playbook to automate a Fail2ban installation on Ubuntu 20.04. #
# The playbook will install and configure Fail2ban onto managed nodes.     #
############################################################################

# Defining target section.
- name: Installing Fail2ban
  hosts: managed_nodes
  become: true
  gather_facts: yes

# Defining variable section.
  vars:
    bantime: 3600
    port: 22
    time: 300
    retry: 3
    email: sk3ma87@gmail.com

# Defining task section.
  tasks:
      - name: Upgrading Ubuntu system
        apt:
          upgrade: yes
          update_cache: yes

      - name: Installing packages
        apt:
          name: "{{ item }}"
          state: present
        with_items:
         - fail2ban
         - sendmail
         - screenfetch
        when: ansible_distribution == 'Ubuntu' and ansible_distribution_version == '20.04'

      - name: Removing execute permissions
        command: "chmod -x /etc/update-motd.d/*"

      - name: Updating Bash shell
        command: "/usr/bin/screenfetch >> /home/vagrant/.bashrc"

      - name: Applying Fail2ban configuration
        template:
          src: "templates/jail.local.j2"
          dest: "/etc/fail2ban/jail.local"
          owner: root
          group: root
          mode: u=rw,g=r,o=r

        notify:
        - restart service

      - name: Confirming SSH status
        command: "fail2ban-client status sshd"

      - name: Printing end status
        debug:
          msg: 'Finished, Fail2ban installed.'

# Defining handler section.
  handlers:
      - name: restart service
        systemd:
          name: fail2ban
          state: restarted
...
